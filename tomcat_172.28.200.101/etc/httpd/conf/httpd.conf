ServerRoot "/etc/httpd"
Listen 80
Include conf.modules.d/*.conf
User apache
Group apache
ServerAdmin root@localhost

<Directory />
  # 상위 디렉토리 접근 금지
  #AllowOverride none
  AllowOverride AuthConfig
  Require all denied
</Directory>

DocumentRoot "/var/www/html"

<Directory "/var/www">
  # 상위 디렉토리 접근 금지
  #AllowOverride None
  AllowOverride AuthConfig
  # HTTP Method 제한
  <LimitExcept GET POST OPTIONS>
    Order allow,deny
    Allow from all
  </LimitExcept>
  Require all granted
</Directory>

<Directory "/var/www/html">
  #Options Indexes FollowSymLinks
  Options
  
  # 상위 디렉토리 접근 금지
  #AllowOverride None
  AllowOverride AuthConfig
  
  # HTTP Method 제한
  <LimitExcept GET POST OPTIONS>
    Order allow,deny
    Allow from all
  </LimitExcept>
  
  Require all granted
</Directory>

<IfModule dir_module>
  DirectoryIndex index.html
</IfModule>

<Files ".ht*">
  Require all denied
</Files>

#ErrorLog "logs/error_log"
ErrorLog "/logs/apache/apache_error.log"

#LogLevel warn
LogLevel debug

<IfModule log_config_module>
  #LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
  LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %b \"%{Referer}i\"" combined
  LogFormat "%h %l %u %t \"%r\" %>s %b" common

  <IfModule logio_module>
    #LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" %I %O" combinedio
  </IfModule>
  
  #CustomLog "logs/access_log" combined
  CustomLog "/logs/apache/apache_access.log" combinedio
</IfModule>

<IfModule alias_module>
  ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"
</IfModule>

<Directory "/var/www/cgi-bin">
  # 상위 디렉토리 접근 금지
  #AllowOverride None
  AllowOverride AuthConfig
  
  # HTTP Method 제한
  <LimitExcept GET POST OPTIONS>
    Order allow,deny
    Allow from all
  </LimitExcept>
  
  Options None
  Require all granted
</Directory>

<IfModule mime_module>
  TypesConfig /etc/mime.types
  AddType application/x-compress .Z
  AddType application/x-gzip .gz .tgz
  AddType text/html .shtml
  AddOutputFilter INCLUDES .shtml
</IfModule>

AddDefaultCharset UTF-8

<IfModule mime_magic_module>
  MIMEMagicFile conf/magic
</IfModule>

EnableSendfile on

# 기본 가상호스트 추가
<VirtualHost *:80>
  ServerName 172.28.200.101
  DocumentRoot "/var/www/html"
  <Location "/">
    Require all granted
  </Location>
</VirtualHost>

# request-body 크기 제한
LimitRequestBody 2147483647

# server header 전송 관리
ServerTokens Prod

# mpm 설정
# LoadModule mpm_event_module  modules/mod_mpm_event.so
LoadModule mpm_prefork_module  modules/mod_mpm_prefork.so
<Ifmodule mpm_prefork_module>
  ServerLimit 1024
  StartServers 5
  MinSpareServers 5
  MaxSpareServers 10
  MaxRequestWorkers 1024
  MaxConnectionsPerChild 0
</Ifmodule>

# rpaf 설정
LoadModule rpaf_module        modules/mod_rpaf.so
<IfModule rpaf_module>
  RPAF_Enable       On
  RPAF_ProxyIPs     172.28.200.1
  RPAF_Header       X-Forwarded-For
  #RPAF_SetHostName Off
  #RPAF_SetHTTPS    Off
  #RPAF_SetPort     Off
</IfModule>

#IncludeOptional conf.d/*.conf
#Include conf.d/smpl.conf
<VirtualHost *:80>
  ServerName smpl.develop.net
  
  ErrorLog "/logs/smpl/smpl-apache_error.log"
  CustomLog "/logs/smpl/smpl-apache_access.log" combinedio
  
  DocumentRoot "/sorc/smpl/web"
  
  <IfModule dir_module>
    #DirectoryIndex index.html jdbc-oracle.jsp
    DirectoryIndex index.html index.jsp
  </IfModule>
  
  <Location />
    Require all granted
    #Order Deny,Allow
    #Allow from 172.28.200.1
    #Deny from all
  </Location>
  
  Header always edit Set-Cookie (.*) "$1; Secure; SameSite=None;"
  
  ProxyRequests Off
  ProxyPreserveHost On
  
  Header add Set-Cookie "ROUTEID=.%{BALANCER_WORKER_ROUTE}e; path=/" env=BALANCER_ROUTE_CHANGED
  
  <Proxy balancer://cluster>
    BalancerMember http://172.28.200.101:8010 route=cluster1 retry=1 acquire=3000 timeout=10000 Keepalive=On
    BalancerMember http://172.28.200.101:8011 route=cluster2 retry=1 acquire=3000 timeout=10000 Keepalive=On
    
    ProxySet stickysession=ROUTEID
    ProxySet lbmethod=byrequests
  </Proxy>
  
  #ProxyPassMatch ^/$          balancer://cluster
  ProxyPassMatch /health      balancer://cluster
  ProxyPassMatch /api/(.*)    balancer://cluster
  ProxyPassMatch /(.*\.jsp.*) balancer://cluster
</VirtualHost>

